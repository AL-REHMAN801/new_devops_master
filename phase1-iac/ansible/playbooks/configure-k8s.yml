---
# Ansible Playbook: Configure Kubernetes
# This playbook configures kubectl and Kubernetes tools

- name: Configure Kubernetes on all nodes
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    kubectl_version: "1.28.0"
    helm_version: "3.12.0"

  tasks:
    - name: Add Kubernetes apt repository key
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Add Kubernetes apt repository
      shell: |
        echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
      args:
        creates: /etc/apt/sources.list.d/kubernetes.list

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install kubectl
      apt:
        name: kubectl
        state: present

    - name: Install kubelet and kubeadm (for worker nodes)
      apt:
        name:
          - kubelet
          - kubeadm
        state: present
      when: "'k8s_nodes' in group_names"

    - name: Hold Kubernetes packages at current version
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubectl
        - kubelet
        - kubeadm
      when: "'k8s_nodes' in group_names"

    - name: Download and install Helm
      unarchive:
        src: "https://get.helm.sh/helm-v{{ helm_version }}-linux-amd64.tar.gz"
        dest: /tmp
        remote_src: yes
        creates: /tmp/linux-amd64/helm

    - name: Move Helm binary to /usr/local/bin
      copy:
        src: /tmp/linux-amd64/helm
        dest: /usr/local/bin/helm
        mode: '0755'
        remote_src: yes

    - name: Install k9s (Kubernetes CLI)
      get_url:
        url: "https://github.com/derailed/k9s/releases/latest/download/k9s_Linux_amd64.tar.gz"
        dest: /tmp/k9s.tar.gz

    - name: Extract k9s
      unarchive:
        src: /tmp/k9s.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        creates: /usr/local/bin/k9s

    - name: Create .kube directory for users
      file:
        path: "/home/{{ item }}/.kube"
        state: directory
        owner: "{{ item }}"
        group: "{{ item }}"
        mode: '0755'
      loop:
        - "{{ ansible_user }}"
        - devops
        - developer
      ignore_errors: yes

    - name: Configure kubectl bash completion
      lineinfile:
        path: "/home/{{ item }}/.bashrc"
        line: "source <(kubectl completion bash)"
        state: present
      loop:
        - "{{ ansible_user }}"
        - devops
        - developer
      ignore_errors: yes

    - name: Configure kubectl alias
      lineinfile:
        path: "/home/{{ item }}/.bashrc"
        line: "alias k=kubectl"
        state: present
      loop:
        - "{{ ansible_user }}"
        - devops
        - developer
      ignore_errors: yes

    - name: Configure Helm bash completion
      lineinfile:
        path: "/home/{{ item }}/.bashrc"
        line: "source <(helm completion bash)"
        state: present
      loop:
        - "{{ ansible_user }}"
        - devops
        - developer
      ignore_errors: yes

    - name: Disable swap (required for Kubernetes)
      command: swapoff -a
      when: "'k8s_nodes' in group_names"

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '.*swap.*'
        state: absent
      when: "'k8s_nodes' in group_names"

    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter
      when: "'k8s_nodes' in group_names"

    - name: Configure sysctl for Kubernetes
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward', value: '1' }
      when: "'k8s_nodes' in group_names"

    - name: Configure containerd
      copy:
        content: |
          version = 2
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
            [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
              SystemdCgroup = true
        dest: /etc/containerd/config.toml
        mode: '0644'
      when: "'k8s_nodes' in group_names"
      notify: Restart containerd

    - name: Verify kubectl installation
      command: kubectl version --client
      register: kubectl_version_output
      changed_when: false

    - name: Display kubectl version
      debug:
        msg: "{{ kubectl_version_output.stdout }}"

    - name: Verify Helm installation
      command: helm version
      register: helm_version_output
      changed_when: false

    - name: Display Helm version
      debug:
        msg: "{{ helm_version_output.stdout }}"

  handlers:
    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
